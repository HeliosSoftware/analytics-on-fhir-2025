{
  "resourceType": "ViewDefinition",
  "name": "DiagnosticReportAtDischargeView",
  "resource": "DiagnosticReport",
  "status": "draft",
  "where": [
    {
      "path": "category.coding.where(system='http://terminology.hl7.org/CodeSystem/v2-0074' and code='LAB').exists()",
      "description": "Filter for Laboratory reports only."
    },
    {
      "path": "status in ('registered', 'partial', 'preliminary')",
      "description": "Filter for reports that are not yet final/complete."
    },
    {
      "path": "encounter.resolve().period.end.exists()",
      "description": "Ensure the encounter has a discharge time."
    },
    {
      "path": "issued > encounter.resolve().period.end",
      "description": "The report was not 'issued' (or finalized) before or at the encounter end time (discharge)."
    }
  ],
  "select": [
    {
      "column": [
        {
          "name": "report_id",
          "path": "id",
          "description": "Unique ID of the pending report."
        },
        {
          "name": "hospital_discharge_time",
          "path": "encounter.resolve().period.end",
          "description": "The time of patient discharge."
        },
        {
          "name": "report_status",
          "path": "status",
          "description": "The status of the report (e.g., preliminary)."
        },
        {
          "name": "encounter_id",
          "path": "encounter.reference",
          "description": "Reference to the Encounter resource."
        }
      ]
    }
  ]
}
