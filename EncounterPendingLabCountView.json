{
  "resourceType": "ViewDefinition",
  "name": "EncounterPendingLabCountView",
  "resource": "Encounter",
  "status": "draft",
  "where": [
    {
      "path": "class.code in ('IMP', 'ACUTE', 'INP')",
      "description": "Filter for inpatient/acute encounters."
    },
    {
      "path": "status = 'finished'",
      "description": "Only consider finished encounters."
    },
    {
      "path": "period.end.exists()",
      "description": "Ensure the encounter has an end/discharge time."
    }
  ],
  "select": [
    {
      "column": [
        {
          "name": "encounter_id",
          "path": "id",
          "description": "Unique ID of the encounter."
        },
        {
          "name": "hospital_discharge_time",
          "path": "period.end",
          "description": "The time of patient discharge."
        },
        {
          "name": "pending_lab_count",
          "path": "DiagnosticReport.where(encounter.reference=id and status in ('registered', 'partial', 'preliminary') and issued > %resource.period.end).count()",
          "description": "Count of lab reports not issued by discharge time."
        }
      ]
    }
  ]
}
